
在实际项目中，一个服务基本都是 *集群模式* 的，也就是*多个 功能相同 的项目在运行*，这样才*能承受更高的并发*。
  
这时一个请求到这个服务，就 *需要确定* **访问哪一个服务器**
  
在Dubbo实现远程调用的过程中,调用的关系可能如下图：

![[负载均衡1.png]]

Dubbo框架 *内部支持* **负载均衡算法**，能够 *尽可能的 让请求在相对空闲的服务器上运行*。

在不同的项目中，可以选用不同的负载均衡策略，以达到最好效果。

## Dubbo内置负载均衡策略算法

**Loadbalance**：就是 *负载均衡* 的意思。

- **random loadbalance：随机分配策略(默认)**  
- *round Robin Loadbalance*：权重平滑分配  
- leastactive Loadbalance：活跃度自动感知分配  
- consistanthash Loadbalance：一致性hash算法分配

实际运行过程中,每个服务器性能不同  

在负载均衡时，*都会有性能权重*，这些策略算法 *都考虑权重问题*。


### 1. 随机分配策略

假设我们当前3台服务器，经过测试它们的 *性能权重比* 值为 5:3:1
下面可以生成一个权重模型  
  
5:3:1
![[随机分配策略.png]]

生成随机数，在哪个范围内让哪个服务器运行。
  
**优点**：*算法简单，效率高*，*长时间*运行下，任务*分配比例准确*。
**缺点**：*偶然性高*，如果连续的几个随机请求发送到 *性能弱的服务器*，会导致异常甚至宕机。


### 2. 权重平滑分配

如果几个服务器*权重一致*，那么就是*依次运行*，*但是*服务器的性能权重一致的*可能性很小*。

所以我们需要权重平滑分配，一个优秀的权重分配算法，应该是 *让 每个服务器 都有机会运行* 的。
  
如果一个集群服务器性能比为5:3:1服务为A,B,C：

>1>A   2>A   3>A   4>A   5>A  
>6>B   7>B   8>B  
>9>C

上面的安排中，连续请求一个服务器肯定是不好的，我们希望所有的服务器都能够穿插在一起运行。

**Dubbo2.7之后** 更新了这个算法使用 "**平滑加权算法**" 优化权重平均分配策略：
- *哪个服务器运行，就减去总权重(这里是9)。运行完之后 各服务器再加上各自的权重*。
![[权重平滑分配.png]]

优点：能够*尽可能的在权重要求的情况下*，实现*请求的穿插运行(交替运行)*，*不会*发生随机策略中的*偶发*情况。
缺点：*服务器较多时*，可能需要*减权和复权的计算*，需要*消耗系统资源*。

### 3. 活跃度自动感知  
  
记录每个服务器处理一次请求的时间  

按照时间比例来分配任务数,运行一次需要时间多的分配的请求数较少

### 4. 一致性Hash算法  
  
根据请求的参数进行hash运算。

以后每次 *相同参数的请求* 都会 *访问固定服务器*。

因为根据参数选择服务器，不能平均分配到每台服务器上，使用的也不多。

## 下载Seata  
  
https://github.com/seata/seata/releases  
https://github.com/seata/seata/releases/download/v1.4.2/seata-server-1.4.2.zip  
我们可以直接从第五阶段资料压缩包中获取。


## 什么是Seata  
  
Seata 是一款 *开源* 的 **分布式事务解决方案**，致力于在*微服务架构*下提供 *高性能 和 简单易用* 的 分布式事务服务。
  
也是 *Spring Cloud Alibaba提供的组件*。
  
Seata官方文档： https://seata.io/zh-cn/
更多信息可以通过官方文档获取


## 为什么需要Seata  
  
我们之前学习了单体项目中的事务，使用的技术叫 *Spring声明式事务*（`@Transactional`注解）。
能够保证一个业务中所有对数据库的操作 **要么都成功，要么都失败**，来*保证数据库的数据完整性*。
  
但是在*微服务的项目*中，*业务逻辑层* 涉及远程调用，当前模块发生异常，无法操作远程服务器回滚。
这时要想让远程调用也支持事务功能，就需要使用 *分布式事务组件Seata*
  
**Seata保证** *微服务远程调用业务* 的 **原子性**。
  
**Seata将为用户提供了** ***AT*** **、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。**

事务的*四大特性*(ACID)：背会四条名字即可
1. 原子性
2. 一致性
3. 隔离性
4. 持久性(永久性)


## Seata的运行原理  
  
观察下面 *事务模型*：
![[Sentinel流程1.png]]

上面结构是比较典型的 **远程调用结构**

如果 *account操作数据库失败* 需要 *让order模块和storage模块撤销(回滚)操作*。
声明式事务不能完成这个操作。

需要**使用Seata来解决**：
![[Sentinel流程2.png]]
  
Seata**构成部分**包含：
- *事务协调器TC*(**T**ransactional **C**oordinator)
- *事务管理器TM*(**T**ransactional **M**anagement)
- *资源管理器RM*(**R**esource **M**anagement)


我们项目使用 **AT(自动)模式** 完成分布式事务的解决。
***AT模式运行过程***：
1. *事务的发起方(TM)* 会向 *事务协调器(TC)* 申请一个 **全局事务id**，**并保存**。
   
2. *Seata* 会 *管理* 事务中所有相关的 *参与方的数据源*，将数据操作 *之前和之后*的 *镜像* 都 **保存在undo_log表** 中，*这个表是seata组件规定的表*，没有它就不能实现效果，依靠它来实现 *提交(commit)* 或 *回滚(roll back)* 的操作。
3. 事务的发起方(*TM*)会 **连同 全局id一起 通过远程调用** ，**运行** *资源管理器(RM)* 中的 *方法*。
4. *RM接收 到全局id*，去运行指定方法，并 *将运行结果的状态 发送给TC*。
5. 如果 **所有分支运行 都正常**，TC会通知所有分支进行*提交*，真正的影响数据库内容，反之如果所有分支中 **有任何一个分支 发生异常** ，TC会通知所有分支进行*回滚*，数据库数据恢复为运行之前的内容。



## Seata的启动  
  
seata也是java开发的，*启动方式和nacos很像*。只是启动命令不同。
  
>它要求配置环境变量中Path属性值有java的bin目录路径  
  
解压后路径不要用中文，不要用空格

也是解压之后的bin目录下：
![[Seata启动文件.png]]
在路径上*输入cmd进入dos窗口*，mac系统同学直接参考启动nacos的命令。
```  
S:\Java\tools\seata\seata-server-1.4.2\bin>seata-server.bat -h 127.0.0.1 -m file
```  
输入后，最后*出现 8091端口 的提示*即可!  

> 如果想使用idea启动seata，和之前nacos启动相似  

如果seata启动时发生内存不足的错误,可以参考下面的文章解决：
https://blog.csdn.net/he_lei/article/details/116229467  

在windows系统中运行seata可能出现不稳定的情况,重启seata即可解决。

保证当前seata的*环境变量*是 **java1.8**。
因为 seata 只支持 JDK1.8 ，如果版本过高的话，需要编辑 *seata-server.bat*，找到 *%JAVACMD% %JAVA_OPTS% -server ...* 开头的那一行，修改为：
```
%JAVACMD% %JAVA_OPTS% -server --add-opens=java.base/java.lang=ALL-UNNAMED -Xmx2048m -Xms2048m -Xmn1024m -Xss512k -XX:SurvivorRatio=10 -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m -XX:MaxDirectMemorySize=1024m -XX:-OmitStackTraceInFastThrow -XX:-UseAdaptiveSizePolicy -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath="%BASEDIR%"/logs/java_heapdump.hprof -XX:+DisableExplicitGC  -Xlog:gc:"%BASEDIR%"/logs/seata_gc.log -verbose:gc -Dio.netty.leakDetectionLevel=advanced -Dlogback.color.disable-for-bat=true -classpath %CLASSPATH% -Dapp.name="seata-server" -Dapp.repo="%REPO%" -Dapp.home="%BASEDIR%" -Dbasedir="%BASEDIR%" io.seata.server.Server %CMD_LINE_ARGS%
```


## 使用Seata

[[15. 使用Seata]]

  

## Seata其他模式介绍

上次课我们讲解了Seata软件 *AT模式的运行流程*。
  
AT模式的运行有一个**非常明显的前提条件**，这个条件不满足，就无法使用AT模式
这个条件就是*事务分支* **都必须是** 操作 **关系型数据库**(Mysql / MariaDB / Oracle)  

**因为关系型数据库才支持 提交和回滚**，其它*非关系型数据库*都是*直接影响数据*(例如Redis)  
  
所以如果我们在业务过程中有一个节点操作的是Redis或其它非关系型数据库时，就无法使用AT模式。
如果必须使用到Redis，就把需要操作Redis的节点移动到Business节点右边（先执行Redis(就盯着它，单独处理)再到Business使用AT模式）

**除了AT模式之外还有TCC、SAGA 和 XA 事务模式**


### TCC模式  
  
简单来说,TCC模式就是 **自己编写代码** *完成事务的提交和回滚*。
  
在TCC模式下，我们需要为参与事务的业务逻辑都编写一组共3个方法：(prepare / commit / rollback)
- prepare：准备，Nosql的调用之类的都写在这里。
- commit：提交，只是发送一个日志，并不执行确切的功能。
- rollback：回滚。
  
- **prepare方法** 是 *每个模块都会运行* 的方法  
* 当所有模块的prepare方法运行 **都正常** 时，运行 *commit*。
* 当任意模块运行的prepare方法 **有异常** 时，运行 *rollback*。
  
这样的话所有提交或回滚代码都由自己编写  

*优点*：虽然代码是自己写的，但是事务整体提交或回滚的机制仍然可用(仍然由TC来调度)
*缺点*：每个业务都要编写3个方法来对应，代码冗余，而且 *业务入侵量大*。


### SAGA模式

该模式主要是为了改善：TCC模式中业务入侵量大的问题。


SAGA模式的思想是对应 *每个业务逻辑层* **编写一个新的类**，可以设置指定的业务逻辑层方法 *发生异常时*，*运行这个新编写的类中的代码*。

一般用于维护老代码，业务逻辑层已经编写完成的情况下。

*缺点* 是每个事务分支都要编写一个类来回滚业务，会造成类的数量较多，开发量较大。


### XA模式

支持XA协议的数据库分布式事务，使用比较少。
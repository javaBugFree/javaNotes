
## 什么是Nacos

Nacos是Spring Cloud Alibaba提供的一个软件。

这个软件主要具有 **注册中心** 和 **配置中心**（课程最后讲解）的*功能*。
我们先学习它注册中心的功能。

*微服务中所有项目* **都必须** 注册到注册中心才能成为微服务的一部分。

注册中心 和 企业中的 人力资源管理部门 类似。

![[注册中心.png]]

当前微服务项目中 *所有的模块*，**在启动前**，都*必须添加注册到* **Nacos的配置**。
化整为零，之后再整合这些零，就需要用到注册中心。

**所谓注册**，就是*将自己的信息，提交到Nacos来保存*。


## Nacos的 下载

https://github.com/alibaba/nacos/releases/download/1.4.3/nacos-server-1.4.3.zip
  
国外网站,下载困难可以多试几次  

或直接向项目经理老师索取

## Nacos的 启动

因为Nacos是Java开发的，
我们要启动Nacos必须保证当前系统配置了java环境变量，简单来说就是要环境变量中，有 *JAVA_HOME* 的配置，指向安装jdk的路径。
![[Java环境变量.png]]
确定了支持Java后，就可以启动Nacos了。

windows的同学保证java环境变量正常后，将nacos-server-1.4.2.zip压缩包解压，双击打开解压得到的文件夹后，再双击打开其中的 **bin目录* * 
![[Nacos的启动1.png]]
  
- cmd结尾的文件是windows版本的
- sh结尾的文件是linux和mac版本的
- startup是启动文件
- shutdown是停止文件

**Windows下启动Nacos不能直接双击cmd文件**  
需要在dos窗口运行，在当前资源管理器地址栏输入cmd
```
S:\Java\tools\nacos\bin>startup.cmd -m standalone
```

- `startup.cmd`：windows启动nacos的命令文件  
- `-m`：表示要设置启动参数  
- `standalone`：翻译为标准的孤独的，意思是正常的使用单机模式启动  
  
*运行成功* **默认占用 8848端口**，并且在代码中提示  
  
如果不输入standalone运行会失败。

如果报了
"please set JAVA_HOME......."  
表示当前项目没有配置java环境变量(主要是没有设置JAVA_HOME)  

如果运行没有报错，打开浏览器输入地址
http://localhost:8848/nacos  
![[Nacos的启动2.png]]
  
如果是首次访问,会出现这个界面，登录系统 
- 用户名：nacos
- 密码：nacos
  
登录之后可以进入后台列表  ，**不能关闭**启动nacos的*dos窗口*。

我们要让我们编写的项目*注册到Nacos*，才能真正是微服务项目


## 使用Idea启动Nacos

之前我们启动Nacos都是使用dos命令行，启动过程比较复杂,命令比较长  
  
*Idea*实际上*支持*我们*更加方便的启动Nacos*  
  
步骤1:  
![[Idea启动Nacos1.png]]

步骤2:
![[Idea启动Nacos2.png]]

步骤3：
![[Idea启动Nacos3.png]]
配置完以上，点确定即可配置成功。

配置成功之后，Nacos就会出现在idea的*启动选项*中了  
![[Idea启动Nacos4.png]]

这种方法实际上*只是为了简便*大家*启动*nacos的操作，还是 **需要掌握命令行的启动方式的!**

## **Nacos的心跳机制**

>常见面试题

*心跳*：**周期性**的操作，来*表示自己是健康可用的机制*

注册到Nacos的微服务项目(模块)都是会遵循这个心跳机制。

心跳机制的**目的**：
1. 是表示当前微服务模块 *运行状态正常的手段*。
2. 是表示 *当前微服务模块* 和 *Nacos* **保持沟通和交换信息** 的机制。

**默认** 情况下，服务启动开始 **每隔5秒** 会向Nacos发送一个"**心跳包**"，这个心跳包中*包含了当前服务的基本信息*。
  
Nacos接收到这个心跳包，**首先检查** 当前服务*在不在注册列表* 中，
**如果不在**，按新服务的业务进行*注册*，**如果在**，表示当前这个服务是*健康状态*。

如果一个服务 **连续3次** 心跳(*默认15秒*)没有和Nacos进行信息的交互，就会将当前服务*标记为不健康的状态*  。
如果一个服务 **连续6次** 心跳(*默认30秒*)没有和Nacos进行信息的交互,Nacos会将这个服务*从注册列表中剔除*  。

**这些时间都是可以通过配置修改的**。


### *实例类型分类*

实际上Nacos的 **服务类型** 还有分类：
* 临时实例(*默认*)  
* 持久化实例(*永久实例*)  
  
默认*每个服务*都是临时实例。

如果想标记一个服务为永久实例：
```yaml  
cloud:  
  nacos:    
    discovery:      
    # ephemeral设置当前项目启动时注册到nacos的类型 true(默认):临时实例 false:永久实例
    ephemeral: false
```  

持久化实例启动时向nacos注册，nacos会对这个实例进行持久化处理。
  
心跳包的规则和临时实例一致，只是*不会将该服务 从列表中剔除*。
  
一般情况下，我们创建的服务都是临时实例，*只有*项目的主干业务才会设置为永久实例。



## 配置中心

### 什么是配置中心
  
所谓配置中心：在 *微服务的环境下*，将 *项目需要的配置信息* **保存在配置中心**，*需要读取时* **直接从配置中心读取**，**方便配置管理** 的 *微服务工具*。
  
我们可以将 *部分 yml文件的内容* 保存在配置中心。
  
一个微服务项目有很多子模块，这些子模块可能在不同的服务器上，如果有一些 *统一的修改*，我们要逐一修改这些子模块的配置，由于 *它们是不同的服务器*，所以 *修改起来很麻烦*。
  
如果将这些子模块的配置 **集中在一个服务器上**，我们 *修改这个服务器的 配置信息*，就*可以修改 所有子模块的信息*，这个服务器就是配置中心。
  
*使用配置中心的 原因* 就是：**能够达到高效的修改各模块配置的目的**


### 配置中心的使用

Nacos既可以做注册中心，也可以做配置中心。
  
Nacos做配置中心，支持 *各种格式 / 类型* 的配置文件。
  
*properties / yaml(yml) / txt / json / xml 等*。


### Nacos数据结构

![[Nacos的数据结构.png]]

**namespace**：*命名空间*。
**group**：*分组*。
**Service / DataId**：*具体数据*。


#### *命名空间：*

namespace是Nacos提供的 *最大 的数据结构*，
  
*一个Nacos* **可以创建多个 命名空间(namespace)**，
*一个命名空间*(namespace)**能够包含多个group**，
*每一个group* 中又 **可以包含多条配置信息**。

在nacos中 *新建命名空间*：
![[Nacos新建命名空间.png]]

在上图连接的位置可以新增命名空间，填写 *命名空间名称 和 描述* 即可，

Nacos有 **默认的命名空间public** *不能删除和修改*，

添加命名空间后，我们在Nacos中注册的服务或添加的配置就可以指定命名空间了，

因为 *多个命名空间 可以隔离项目*，*每个项目 使用自己的命名空间，互不干扰*。

![[Nacos多个命名空间.png]]


#### *分组*

一个命名空间中可以有 *多个分组*，进行 *进一步分离*。
  
我们使用时，*如果不需要进一步分组*，推荐 *使用group名称*：`DEFAULT_GROUP`。


#### *服务或配置*

确定了命名空间和分组之后，我们就可以添加服务或配置了。

之前我们启动的 *各种模块都是服务*，这些服务都是 *默认保存* 在 **public命名空间** 中，

下面我们主要使用配置中心的功能，*在命名空间中添加配置*。

*添加配置* 就是 **设置DataId**。

实际在Nacos中 **定位** *一个配置的 结构* 为：
**Namespace>Group>DataId**



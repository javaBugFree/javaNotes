
当通过登录验证后，在`SecurityContext`中就已经存入了认证信息（`Authentication`），在认证信息中还包含了当事人（`Principal`），后续，可以在任何*需要识别当事人的场景*中，*获取此当事人信息*！  
  
在控制器中处理请求的方法的参数列表上，可以注入当事人类型的参数，并且需要在此参数上添加`@AuthenticationPrincipal`注解：  
```java  
@GetMapping("")  
//                                        ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ 注解  
public JsonResult<List<AdminListVO>> list(@AuthenticationPrincipal UserDetails userDetails) {  
//↑↑↑↑↑↑↑↑↑ 当事人类型
    log.debug("开始处理【查询管理员列表】的请求，参数：无");  
    log.debug("当事人信息：{}", userDetails);  
    log.debug("当事人信息中的用户名：{}", userDetails.getUsername());  
    List<AdminListItemVO> list = adminService.list();    
    return JsonResult.ok(list);
}  
```  
  
*注意*：当添加以上参数后，API文档框架会*误以为*此参数是*需要由客户端提交*的*请求参数*，在API文档的*调试页面*中*将显示相对应的输入框*（可能需要刷新），要求输入相关的参数，实际此参数是由Spring Security从`SecurityContext`中取出认证信息中的当事人来注入的，*并不应该由客户端提交*，所以，应该在此**参数上**添加`@ApiIgnore`注解，表示API文档应该*忽略此参数*：  
```java  
@GetMapping("")  
//                                            ↓↓↓↓↓↓↓↓↓↓ 注解  
public JsonResult<List<AdminListItemVO>> list(@ApiIgnore @AuthenticationPrincipal UserDetails userDetails) {  
    log.debug("开始处理【查询管理员列表】的请求，参数：无");  
    log.debug("当事人信息：{}", userDetails);  
    log.debug("当事人信息中的用户名：{}", userDetails.getUsername());  
    List<AdminListItemVO> list = adminService.list();    
    return JsonResult.ok(list);
}  
```  


## 自定义类型的当事人

由于Spring Security框架要求`loadUserByUsername()`返回`UserDetails`类型的对象，且框架提供的实现类`User`中*并不完全包含*开发实践时**所需要的属性**，*例如ID等*，则使用Spring Security已有的类型并不能满足编程需求！  
  
可以**自定义类**，
1. 实现`UserDetails`接口，或者，继承自`User`类，
2. 然后，在自定义类中*声明所需的各属性*等，
3. 后续，在`loadUserByUsername()`中*返回自定义类的对象*，
则**验证登录通过时**返回的*认证信息中的当事人*也是此对象，*存入到*`SecurityContext`中的认证信息也是同一个认证信息，所以在*控制器的方法* 中*注入*的当事人也是此对象！  

1. 在项目的根包下创建`security.AdminDetails`类，继承自`User`类：
```java  
/**  
 * 自定义类型的当事人 
 */  
@Getter  
@ToString(callSuper = true)  
@EqualsAndHashCode(callSuper = true)  
public class AdminDetails extends User {  
  
    private Long id;  
  
    public AdminDetails(Long id,  
                        String username,  
                        String password,  
                        boolean enabled,  
                        Collection<? extends GrantedAuthority> authorities) {  
        super(username,  
                password,  
                enabled,  
                true,   // 不需要传的参数直接放个 true                true,  
                true,  
                authorities);  
  
        this.id = id;  
    }  
}
```  
  
3. 然后，在`UserDetailsServiceImpl`中，在`loadUserByUsername()`方法中返回以上自定义类的对象：  
```java  
@Override  
public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {  
    AdminLoginInfoVO loginInfo = adminMapper.getLoginInfoByUsername(s);  
    if (loginInfo == null) {  
        return null;  
    }  
  
    List<GrantedAuthority> authorities = new ArrayList<>();  
    authorities.add(new SimpleGrantedAuthority("这是第一个临时使用的山寨权限"));  
    authorities.add(new SimpleGrantedAuthority("这是第二个临时使用的山寨权限"));  
  
    AdminDetails adminDetails = new AdminDetails(  
            loginInfo.getId(),  
            loginInfo.getUsername(),  
            loginInfo.getPassword(),  
            loginInfo.getEnable() == 1,  
            authorities);  
    return adminDetails;  
}  
```  
  
后续，在控制器类中处理请求的方法的参数列表中，就可以注入自定义类型的当事人：  
```java  
// http://localhost:8091/admins  
@PostMapping("")  
@ApiOperation("管理员列表")  
@ApiOperationSupport(order = 420)

public JsonResult<List<AdminListVO>> list(@ApiIgnore @AuthenticationPrincipal AdminDetails adminDetails) {  
//                       ↑↑↑↑↑↑↑↑↑↑↑↑   自定义类型的当事人  
    log.debug("开始处理【查询管理员列表】业务");  
    log.debug("当事人信息：{}", adminDetails);  
    log.debug("当事人信息中的ID：{}", adminDetails.getId()); // 获取扩展的ID属性的值  
    log.debug("当事人信息中的用户名：{}", adminDetails.getUsername());  
    List<AdminListVO> list = adminService.list();  
    return JsonResult.success(list);  
}
```  
  
  
  
  
  
  
  
```  
2023-03-07 14:41:58.019 DEBUG 29640 --- [nio-9081-exec-1] c.t.c.p.service.impl.AdminServiceImpl    : 认证结果：  
  
UsernamePasswordAuthenticationToken [  
   Principal=AdminDetails(super=cn.tedu.csmall.passport.security.AdminDetails [      Username=liucangsong,      Password=[PROTECTED],   
      Enabled=true,   
      AccountNonExpired=true,   
      credentialsNonExpired=true,   
      AccountNonLocked=true,   
      Granted Authorities=[这是第一个临时使用的山寨权限, 这是第二个临时使用的山寨权限]],   
      id=3),   
   Credentials=[PROTECTED],   
   Authenticated=true,   
   Details=null,   
   Granted Authorities=[这是第一个临时使用的山寨权限, 这是第二个临时使用的山寨权限]  
]  
```
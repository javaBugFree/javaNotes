
## 订单的状态码  
  
我们电商上面订单的状态修改是非常普通的业务  
  
随着商品的购买流程,订单的状态有  
  
状态:  
0=未支付  
1=已关闭（超时未支付）  
2=已取消  
3=已支付  
4=已签收  
5=已拒收
6=退款处理中
7=已退款


## 开发更新订单状态的持久层  
  
修改订单状态就是根据 *订单id* 修改订单的 *state*。
我们随着业务的发展，订单可能需要更多修改的需求

订单的列(字段)比较多，如果每个字段修改，都需要编写一个方法的话，那么方法的数量会非常多
如果我们编写一个方法，能够接收订单对象的实体类参数(OmsOrder)
我们要实现可以根据OmsOrder对象的实际数据来实现动态的修改要修改的字段
Mybatis中可以通过编写 *动态修改sql语句* 完成这个需求。

*OmsOrderMapper*接口添加方法：
```java
/**  
 * 利用动态sql，实现对订单对象中指定字段的修改  
 * 参数OmsOrder对象，其中必须包含id值，其他属性哪列有值就修改哪列  
 *  
 * @param order 要修改的信息  
 * @return 修改的行数  
 */  
int updateOrderById(OmsOrder order);
```


*OmsOrderMapper.xml* 编写sql
```xml
<!-- 利用动态sql，实现对订单对象中指定字段的修改 -->  
<!-- int updateOrderById(OmsOrder order); -->  
<!--  
    OmsOrder对象动态修改数据库中数据的sql语句  
    Mybatis框架根据OmsOrder对象中属性的非空状态，来生成sql语句  
    使用<set>标签，这个标签的功能：  
    1. 在<set>标签的位置生成set关键字  
    2. 在<set>至</set>之间，生成的sql语句如果最后一个字符是","会将这个","删除  
-->  
<update id="updateOrderById">  
    UPDATE oms_order    
    <set>  
        <if test="contactName!=null">  
            contact_name=#{contactName},        
        </if>  
        <if test="mobilePhone!=null">  
            mobile_phone=#{mobilePhone},        
        </if>  
        <if test="telephone!=null">  
            telephone=#{telephone},        
        </if>  
        <if test="streetCode!=null">  
            street_code=#{streetCode},        
        </if>  
        <if test="streetName!=null">  
            street_name=#{streetName},        
        </if>  
        <if test="detailedAddress!=null">  
            detailed_address=#{detailedAddress},        
        </if>  
        <if test="tag!=null">  
            tag=#{tag},        
        </if>  
        <if test="paymentType!=null">  
            payment_type=#{paymentType},        
        </if>  
        <if test="state!=null">  
            state=#{state},        
        </if>  
        <if test="rewardPoint!=null">  
            reward_point=#{rewardPoint},        
        </if>  
        <if test="amountOfOriginalPrice!=null">  
            amount_of_original_price=#{amountOfOriginalPrice},        
        </if>  
        <if test="amountOfFreight!=null">  
            amount_of_freight=#{amountOfFreight},        
        </if>  
        <if test="amountOfDiscount!=null">  
            amount_of_discount=#{amountOfDiscount},        
        </if>  
        <if test="amountOfActualPay!=null">  
            amount_of_actual_pay=#{amountOfActualPay},        
        </if>  
        <if test="gmtPay!=null">  
            gmt_pay=#{gmtPay},        
        </if>  
    </set>  
    WHERE id = #{id}
</update>
```


## 开发业务逻辑层

*OmsOrderServiceImpl*实现方法
```java
// 根据订单id，修改订单状态  
@Override  
public void updateOrderState(OrderStateUpdateDTO orderStateUpdateDTO) {  
    // 先实例化OmsOrder对象  
    OmsOrder omsOrder = new OmsOrder();  
    // orderStateUpdateDTO参数属性只有id和state，实现修改订单状态，进行赋值  
    BeanUtils.copyProperties(orderStateUpdateDTO, omsOrder);  
    // 调用动态修改方法，因为orderStateUpdateDTO中只有state和id属性，所以只会修改state  
    orderMapper.updateOrderById(omsOrder);  
}
```


## 开发控制层

```java
@PostMapping("/update/state")  
@ApiOperation("根据订单id修改订单状态")  
@PreAuthorize("hasAuthority('ROLE_user')")  
public JsonResult updateState(@Validated OrderStateUpdateDTO orderStateUpdateDTO) {  
  
    omsOrderService.updateOrderState(orderStateUpdateDTO);  
  
    return JsonResult.ok("修改完成！");  
}
```


## 测试

重启order模块  
测试时根据实际数据库订单id,修改knife4j的数据然后再运行  
  
运行后查看数据库中订单状态列是否修改